#!/bin/bash
# For each ArchiveBot job running on the machine, list requests that are stuck, i.e. older than 6 hours
ps -C wpull --format 'pid,cmd' --no-headers | sed 's,^\s*,,; s,\s*/usr/bin/python3.*/data/[^/]\+/\([0-9a-z]\+\)/wpull\.log.*$, \1,' | while read -r pid jobid; do echo "$jobid (PID $pid)"; find /proc/${pid}/fd -lname '*/tmp-wpull-warcsesreq-*' -printf "%l\0" | xargs -0 bash -c 'find "$@" -mmin +360 -printf "%TY-%Tm-%Td %TH:%TM:%TS %TZ\0%p\0"' bash 2> >(grep -v ': No such file or directory$' >&2) | while IFS= read -r -d '' mtime; IFS= read -r -d '' filename; do grep ^Host "${filename}" | while read -r outline; do echo "${mtime} ${filename} ${outline}"; done; done | sort | sed 's,\.[0-9]\+,,' | grep ^ || echo 'None'; echo; done
